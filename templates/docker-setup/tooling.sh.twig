#!/usr/bin/env bash

# -e: fail script on a failed command / pipeline
# -u: fail script on unset variables
set -eu

{% include "docker-setup/partials/import-proxy.sh.twig" %}

{%- set osPackages=[] -%}

{# Step 1: Gather all the OS packages we need #}

{# Step 2: Install the OS packages #}

{% if osPackages|length > 0 %}
# Install packages
    {%- if config.get("os.name")=="ubuntu" -%}
# Update cache, in case one of the dependencies has pulled in a custom repository
apt-get update
apt-get install -yf \
    {{ osPackages | sort | join(" \\\n    ") }}

# Save space from artifacts (can be regenerated, if needed, with apt-get update)
apt-get clean
rm -rf /var/lib/apt/lists/*
    {%- elseif config.get("os.name")=="alpine" %}
    {%- endif -%}
{% endif %}

{# Step 3: Configure the OS packages #}

{% if config.get("os.name")=="ubuntu" %}
{% elseif config.get("os.name")=="alpine" %}
{% endif %}

{% if config.get("nodejs.enabled") and config.get("nodejs.target")=="tooling" %}
    {%- include "docker-setup/partials/nodejs.sh.twig" %}
{% endif %}

{% include "docker-setup/partials/remove-proxy.sh.twig" %}
